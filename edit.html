<html>
<head>
<title>edit list</title>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" crossorigin="anonymous">
<!-- Latest compiled and minified JavaScript -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" crossorigin="anonymous"></script>
<script src="storage-gist.js"></script>
</head>
<body>
  <div id="input" class="container-fluid" style="padding: 100px;">
    <div class="row">
        <div class="col-xs-8 col-xs-offset-2">
            <form class="form-inline" target="_self" onsubmit="javascript:setLid();return false;">
                <div class="form-group">
                    <label for="uname">list id:</label>
                    <input type="text" class="form-control" id="uname" name="uname" placeholder="info17">
                    <label for="pw">pass phrase:</label>
                    <input type="text" class="form-control" id="pw" name="pw" placeholder="TBA.">
                </div>
                <button type="submit" class="btn btn-default">Go</button>
            </form>
        </div>
    </div>
    <script>
    function setLid() {
      uname = document.getElementById("uname").value;
      window.location.href = "#"+uname;
      window.location.reload();
    }
    </script>
  </div>

  <div id="main" style="display: none; vertical-align: text-top;">
    <textarea id="tsv" onblur="decodeList(this.value);" style="height:100%; width:40%; display:inline-block">
    </textarea>
    <div style="height:100%; width:30%; display:inline-block">
      <table id="tbl" class="table">
        <tr><th>name</th><th>GJ</th><th>ZJ</th></tr>
      </table>
    </div>
    <form style="width:25%; display:inline-block" onsubmit="save();return false;">
        <textarea id="preview" style="width:100%; height:10em;"></textarea>
        <button type="submit">save</button>
    </form>
  </div>
  
  <script>
    finalData = {
      user: [],
      prob: []
    };
    function save() {
      putFile("list-"+lid, $("#preview").text());
    }
    
    users = [];
    function decodeList(code) {
      decodeListToTbl(code);
      users = decodeListToObj(code);
      console.log("users="+JSON.stringify(users));
      finalData['user'] = users;
      $("#preview").text(JSON.stringify(finalData));
    }
    function decodeListToTbl(code) {
      $("#tbl tr:not(:first-child)").remove();
      lines = code.trim().split("\n");
      lines.forEach(function(line) {
        tr = $("<tr>");
        cols = line.split("\t");
        td = $("<th>"+cols[0]+"</th>");
        tr.append(td);
        ncol = cols.length;
        for (i=1; i<ncol; i++) {
          td = $("<td>"+cols[i]+"</td>");
          tr.append(td);
        }
        $("#tbl").append(tr);
      });
    }
    function decodeListToObj(code) {
      objs = [];
      lines = code.trim().split("\n");
      lines.forEach(function(line) {
        cols = line.split("\t");
        obj = {name:cols[0], gj:cols[1], zj:cols[2]};
        objs.push(obj);
      });
      return objs;
    }
    
    function main(lid) {
    	getFile("list-"+lid, function(data) {
    		$("#preview").text(data);
    		if (!data) return;
    		obj = JSON.parse(data);
    		if (!obj) return;
    		users = obj.user;
    		retv = "";
    		users.forEach(function(user) {
    			retv += user.name + "\t" + user.gj + "\t" + user.zj + "\n";
    		});
    		$("#tsv").text(retv);
    	});
    }

    lid = window.location.hash.substring(1);
    if (lid.length>0) {
      main(lid);
      $("#input").hide();
      $("#main").show();
    }
  </script>
</body>
</html>
